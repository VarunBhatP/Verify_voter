## Google Cloud Run Deployment Commands

# These commands should be run once the Google Cloud SDK is properly installed and configured
# Replace [PROJECT_ID] with your actual Google Cloud project ID
# Replace [REGION] with your preferred region (e.g., us-central1)

# 1. Set your project
gcloud config set project [PROJECT_ID]

# 2. Enable required APIs
gcloud services enable containerregistry.googleapis.com
gcloud services enable run.googleapis.com
gcloud services enable cloudbuild.googleapis.com

# 3. Configure Docker to use Google Container Registry
gcloud auth configure-docker

# 4. Build and push the face verification Docker image
docker build -t gcr.io/[PROJECT_ID]/evote-face-verification:latest -f Dockerfile .
docker push gcr.io/[PROJECT_ID]/evote-face-verification:latest

# 5. Build and push the backend Docker image
docker build -t gcr.io/[PROJECT_ID]/evote-backend:latest -f Dockerfile.backend .
docker push gcr.io/[PROJECT_ID]/evote-backend:latest

# 6. Deploy the face verification service to Cloud Run
gcloud run deploy evote-face-verification \
  --image gcr.io/[PROJECT_ID]/evote-face-verification:latest \
  --platform managed \
  --region [REGION] \
  --allow-unauthenticated \
  --memory 2Gi \
  --cpu 2 \
  --timeout 300s \
  --set-env-vars="PORT=5001,PYTHONUNBUFFERED=1,DEEPFACE_HOME=/app/deepface_weights"

# 7. Get the URL of the face verification service
FACE_VERIFICATION_URL=$(gcloud run services describe evote-face-verification --platform managed --region [REGION] --format="value(status.url)")

# 8. Deploy the backend service to Cloud Run
gcloud run deploy evote-backend \
  --image gcr.io/[PROJECT_ID]/evote-backend:latest \
  --platform managed \
  --region [REGION] \
  --allow-unauthenticated \
  --set-env-vars="NODE_ENV=production,PORT=3000,MONGODB_URI=[YOUR_MONGODB_URI],JWT_SECRET=[YOUR_JWT_SECRET],FACE_VERIFICATION_URL=$FACE_VERIFICATION_URL"

# 9. Get the URL of the backend service
BACKEND_URL=$(gcloud run services describe evote-backend --platform managed --region [REGION] --format="value(status.url)")

echo "Deployment complete!"
echo "Face Verification Service URL: $FACE_VERIFICATION_URL"
echo "Backend Service URL: $BACKEND_URL"
